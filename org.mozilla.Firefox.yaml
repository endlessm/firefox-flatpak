app-id: org.mozilla.Firefox
runtime: org.freedesktop.Platform
runtime-version: '18.08'
sdk: org.freedesktop.Sdk
separate-locales: false
build-options:
  no-debuginfo: true
command: firefox
finish-args:
  - '--share=ipc'
  - '--share=network'
  - '--socket=pulseaudio'
  - '--socket=x11'
  - '--filesystem=home'
  - '--talk-name=org.gnome.vfs.*'
  - '--device=dri'
  - '--filesystem=xdg-run/dconf'
  - '--filesystem=xdg-config/dconf:ro'
  - '--talk-name=ca.desrt.dconf'
  - '--env=DCONF_USER_CONFIG_DIR=.config/dconf'
  - '--talk-name=org.freedesktop.FileManager1'
  - '--system-talk-name=org.freedesktop.NetworkManager'
  - '--talk-name=org.a11y.Bus'
  - '--talk-name=org.gnome.SessionManager'
  - '--talk-name=org.freedesktop.ScreenSaver'
  - '--talk-name=org.gtk.vfs.*'
modules:
  - shared-modules/gtk2/gtk2.json

  - name: dbus-glib
    cleanup:
      - '*.la'
      - /bin
      - /etc
      - /include
      - /libexec
      - /share
    config-opts:
      - '--disable-static'
      - '--disable-gtk-doc'
    sources:
      - type: archive
        url: https://dbus.freedesktop.org/releases/dbus-glib/dbus-glib-0.108.tar.gz
        sha256: 9f340c7e2352e9cdf113893ca77ca9075d9f8d5e81476bf2bf361099383c602c

  - name: firefox
    buildsystem: simple
    build-commands:
      - 'install -Dm 755 apply_extra.sh /app/bin/apply_extra'
      - 'install -Dm 755 firefox.sh /app/bin/firefox'
      - 'install -Dm 755 firefox-plugins-installer /app/bin/firefox-plugins-installer'

      - 'install -Dm 644 -t /app/share/metainfo org.mozilla.Firefox.appdata.xml'
      - 'install -Dm 644 -t /app/share/applications org.mozilla.Firefox.desktop'
      - 'install -Dm 644 eos-app-org.mozilla.Firefox.png /app/share/icons/hicolor/64x64/apps/org.mozilla.Firefox.png'

      - 'install -Dm 644 -t /app/firefox/data endless-default-prefs.js'
    sources:
      - type: script
        dest-filename: firefox.sh
        commands:
          - |
            # Launch the script that installs the plugins (if needed) in the background
            # so it installs them while Firefox is already running, avoiding the user
            # to wait
            /app/bin/firefox-plugins-installer &

            export TMPDIR=$XDG_CACHE_HOME/tmp
            exec /app/extra/firefox/firefox "$@"

      - type: script
        dest-filename: apply_extra.sh
        commands:
          - |
            tar xf firefox-*.tar.bz2
            rm firefox-*.tar.bz2

            mkdir -p firefox/{distribution/extensions,browser/defaults/preferences}
            ln -s /app/firefox/data/endless-default-prefs.js firefox/browser/defaults/preferences

            for xpi in *.xpi; do
              mv $xpi firefox/distribution/extensions/langpack-${xpi%.*}@firefox.mozilla.org.xpi
            done

      - type: file
        path: firefox-plugins-installer
      - type: file
        path: org.mozilla.Firefox.appdata.xml
      - type: file
        path: org.mozilla.Firefox.desktop
      - type: file
        url: https://github.com/endlessm/eos-shell-content/raw/master/icons/bundle/64x64/apps/eos-app-org.mozilla.Firefox.png
        sha256: e4763960556cd5f54366fdc39c92079850975a89683f0335dfb166376dba92a2
      - type: file
        path: endless-default-prefs.js
      - firefox-sources.json
